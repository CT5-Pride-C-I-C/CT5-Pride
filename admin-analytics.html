<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Analytics - CT5 Pride</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" type="image/svg+xml" href="Images/Logo-with-Transparent-background.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-container { max-width: 900px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 2rem; }
        .analytics-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; }
        .analytics-title { font-size: 2rem; font-weight: 700; color: #495057; }
        .analytics-metrics { display: flex; gap: 2rem; flex-wrap: wrap; margin-bottom: 2rem; }
        .metric-box { background: #f8f9fa; border-radius: 8px; padding: 1.5rem 2rem; min-width: 180px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .metric-label { font-size: 1rem; color: #6c757d; margin-bottom: 0.5rem; }
        .metric-value { font-size: 2rem; font-weight: 600; color: #667eea; }
        .chart-section { margin-top: 2rem; }
        .role-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
        .role-table th, .role-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e9ecef; text-align: left; }
        .role-table th { background: #f1f3f5; color: #495057; font-weight: 600; }
        .role-table td { color: #495057; }
    </style>
</head>
<body>
    <div class="admin-sidebar">
        <a href="admin-add-role.html">Dashboard</a>
        <a href="admin-analytics.html" class="active">Analytics</a>
        <button id="logoutBtn" class="button outline" style="margin-top:2rem;">Logout</button>
    </div>
    <div class="analytics-container">
        <div class="analytics-header">
            <div class="analytics-title">ðŸ“Š Volunteer Analytics</div>
        </div>
        <div class="analytics-metrics">
            <div class="metric-box">
                <div class="metric-label">Total Applications</div>
                <div class="metric-value" id="totalApplications">0</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Last 7 Days</div>
                <div class="metric-value" id="apps7">0</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Last 30 Days</div>
                <div class="metric-value" id="apps30">0</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Last 90 Days</div>
                <div class="metric-value" id="apps90">0</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Active Roles</div>
                <div class="metric-value" id="activeRoles">0</div>
            </div>
        </div>
        <div class="chart-section">
            <canvas id="trendChart" height="100"></canvas>
        </div>
        <h3 style="margin-top:2.5rem;">Applications per Role</h3>
        <table class="role-table" id="roleTable">
            <thead>
                <tr><th>Role</th><th>Applications</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        // Supabase Auth session check
        const SUPABASE_URL = 'https://rmhnrpwbgxyslfwttwzr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtaG5ycHdiZ3h5c2xmd3R0d3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTQyMDcsImV4cCI6MjA2ODY5MDIwN30.yNlkzFMfvUCoN6IwEY4LgL6_ihdR_ux22oqvDnkWTxg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'admin-login.html';
            }
        });
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'admin-login.html';
        });
        // Fetch analytics data
        async function fetchAnalytics() {
            const { data: apps } = await supabase.from('applications').select('*');
            const { data: roles } = await supabase.from('roles').select('*');
            // Metrics
            document.getElementById('totalApplications').textContent = apps.length;
            const now = new Date();
            const daysAgo = d => new Date(now.getTime() - d*24*60*60*1000);
            document.getElementById('apps7').textContent = apps.filter(a => new Date(a.submitted_at) > daysAgo(7)).length;
            document.getElementById('apps30').textContent = apps.filter(a => new Date(a.submitted_at) > daysAgo(30)).length;
            document.getElementById('apps90').textContent = apps.filter(a => new Date(a.submitted_at) > daysAgo(90)).length;
            document.getElementById('activeRoles').textContent = roles.filter(r => r.status === 'open').length;
            // Applications per role
            const roleCounts = {};
            apps.forEach(a => { roleCounts[a.role_id] = (roleCounts[a.role_id]||0)+1; });
            const tbody = document.getElementById('roleTable').querySelector('tbody');
            tbody.innerHTML = '';
            roles.forEach(r => {
                const count = roleCounts[r.id] || 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.title}</td><td>${count}</td>`;
                tbody.appendChild(tr);
            });
            // Weekly trend chart
            const weeks = {};
            apps.forEach(a => {
                const d = new Date(a.submitted_at);
                const year = d.getFullYear();
                const week = Math.ceil((((d - new Date(year,0,1)) / 86400000) + new Date(year,0,1).getDay()+1)/7);
                const key = `${year}-W${week}`;
                weeks[key] = (weeks[key]||0)+1;
            });
            const sortedWeeks = Object.keys(weeks).sort();
            const chart = new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedWeeks,
                    datasets: [{
                        label: 'Applications per Week',
                        data: sortedWeeks.map(w => weeks[w]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        fetchAnalytics();
    </script>
</body>
</html> 